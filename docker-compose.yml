# ==================== Production/Staging Docker Compose ====================
# Uses existing external services (MySQL, PostgreSQL, Redis) on the host
# Run with: docker-compose up -d

services:
  # ==================== API Service ====================
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: nurseprompt-api
    restart: unless-stopped
    ports:
      - "${APP_PORT:-8050}:8050"
    environment:
      - APP_NAME=${APP_NAME:-NursePrompt API}
      - APP_ENV=${APP_ENV:-production}
      - APP_HOST=0.0.0.0
      - APP_PORT=8050
      - APP_PREFORK=false
      # Database - connects to existing PostgreSQL container (secure_postgres)
      - DB_HOST=${DB_HOST:-secure_postgres}
      - DB_PORT=${DB_PORT:-5432}
      - DB_USER=${DB_USER:-postgres}
      - DB_PASSWORD=${DB_PASSWORD:-postgres}
      - DB_NAME=${DB_NAME:-boilerplate}
      - DB_SSL_MODE=${DB_SSL_MODE:-disable}
      # Redis - connects to existing Redis container (redis-auth)
      - REDIS_HOST=${REDIS_HOST:-redis-auth}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - REDIS_DB=${REDIS_DB:-0}
      # JWT Configuration
      - JWT_SECRET=${JWT_SECRET:-change-this-in-production}
      - JWT_EXPIRY=${JWT_EXPIRY:-24h}
      - JWT_REFRESH_EXPIRY=${JWT_REFRESH_EXPIRY:-168h}
      # Rate Limiting
      - RATE_LIMIT_MAX=${RATE_LIMIT_MAX:-100}
      - RATE_LIMIT_WINDOW=${RATE_LIMIT_WINDOW:-1m}
      # Security
      - BCRYPT_COST=${BCRYPT_COST:-12}
    networks:
      - staging-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8000/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

# ==================== Networks ====================
networks:
  staging-network:
    external: true
    name: ${DOCKER_NETWORK:-bridge}
